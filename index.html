<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Checklist Provir Segurança Ocupacional</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="script.js"></script>
    <style>
        /* Estilos personalizados */

        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            padding: 20px;
        }

        h1 {
            color: #004080;
        }

        form {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin-top: 10px;
            color: #333;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background-color: #004080;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
    <script>
        var riscoCount = 1;

        function adicionarNovoRisco(funcaoId) {
            var riscosContainer = document.getElementById('riscosContainer' + funcaoId);
            riscoCount++;

            var riscoGroup = document.createElement('div');
            riscoGroup.classList.add('risco-group');

            var riscoHeading = document.createElement('h4');
            riscoHeading.textContent = 'Risco ' + riscoCount;

            var nomeRiscoLabel = document.createElement('label');
            nomeRiscoLabel.setAttribute('for', 'nomeRisco' + riscoCount);
            nomeRiscoLabel.textContent = 'Nome do Risco:';
            var nomeRiscoInput = document.createElement('input');
            nomeRiscoInput.setAttribute('type', 'text');
            nomeRiscoInput.setAttribute('id', 'nomeRisco' + riscoCount);
            nomeRiscoInput.setAttribute('name', 'nomeRisco');

            var fonteRiscoLabel = document.createElement('label');
            fonteRiscoLabel.setAttribute('for', 'fonteRisco' + riscoCount);
            fonteRiscoLabel.textContent = 'Fonte do Risco:';
            var fonteRiscoInput = document.createElement('input');
            fonteRiscoInput.setAttribute('type', 'text');
            fonteRiscoInput.setAttribute('id', 'fonteRisco' + riscoCount);
            fonteRiscoInput.setAttribute('name', 'fonteRisco');

            var exposicaoRiscoLabel = document.createElement('label');
            exposicaoRiscoLabel.setAttribute('for', 'exposicaoRisco' + riscoCount);
            exposicaoRiscoLabel.textContent = 'Exposição do Risco:';
            var exposicaoRiscoInput = document.createElement('input');
            exposicaoRiscoInput.setAttribute('type', 'text');
            exposicaoRiscoInput.setAttribute('id', 'exposicaoRisco' + riscoCount);
            exposicaoRiscoInput.setAttribute('name', 'exposicaoRisco');

            var propagacaoRiscoLabel = document.createElement('label');
            propagacaoRiscoLabel.setAttribute('for', 'propagacaoRisco' + riscoCount);
            propagacaoRiscoLabel.textContent = 'Meio de Propagação:';
            var propagacaoRiscoInput = document.createElement('input');
            propagacaoRiscoInput.setAttribute('type', 'text');
            propagacaoRiscoInput.setAttribute('id', 'propagacaoRisco' + riscoCount);
            propagacaoRiscoInput.setAttribute('name', 'propagacaoRisco');

            var lesaoRiscoLabel = document.createElement('label');
            lesaoRiscoLabel.setAttribute('for', 'lesaoRisco' + riscoCount);
            lesaoRiscoLabel.textContent = 'Lesões:';
            var lesaoRiscoInput = document.createElement('input');
            lesaoRiscoInput.setAttribute('type', 'text');
            lesaoRiscoInput.setAttribute('id', 'lesaoRisco' + riscoCount);
            lesaoRiscoInput.setAttribute('name', 'lesaoRisco');

            var tipoAvaliacaoRiscoLabel = document.createElement('label');
            tipoAvaliacaoRiscoLabel.setAttribute('for', 'tipoAvaliacaoRisco' + riscoCount);
            tipoAvaliacaoRiscoLabel.textContent = 'Tipo de Avaliação:';
            var tipoAvaliacaoRiscoSelect = document.createElement('select');
            tipoAvaliacaoRiscoSelect.setAttribute('id', 'tipoAvaliacaoRisco' + riscoCount);
            tipoAvaliacaoRiscoSelect.setAttribute('name', 'tipoAvaliacaoRisco');
            var qualitativoOption = document.createElement('option');
            qualitativoOption.setAttribute('value', 'qualitativo');
            qualitativoOption.textContent = 'Qualitativo';
            var quantitativoOption = document.createElement('option');
            quantitativoOption.setAttribute('value', 'quantitativo');
            quantitativoOption.textContent = 'Quantitativo';
            tipoAvaliacaoRiscoSelect.appendChild(qualitativoOption);
            tipoAvaliacaoRiscoSelect.appendChild(quantitativoOption);
            tipoAvaliacaoRiscoSelect.addEventListener('change', function () {
                var avaliacaoQuantitativaContainer = document.getElementById('avaliacaoQuantitativaContainer' + riscoCount);
                if (this.value === 'quantitativo') {
                    avaliacaoQuantitativaContainer.style.display = 'block';
                } else {
                    avaliacaoQuantitativaContainer.style.display = 'none';
                }
            });

            var avaliacaoQuantitativaContainer = document.createElement('div');
            avaliacaoQuantitativaContainer.setAttribute('id', 'avaliacaoQuantitativaContainer' + riscoCount);
            avaliacaoQuantitativaContainer.style.display = 'none';
            var avaliacaoQuantitativaLabel = document.createElement('label');
            avaliacaoQuantitativaLabel.setAttribute('for', 'avaliacaoQuantitativa' + riscoCount);
            avaliacaoQuantitativaLabel.textContent = 'Avaliação Quantitativa:';
            var avaliacaoQuantitativaInput = document.createElement('input');
            avaliacaoQuantitativaInput.setAttribute('type', 'file');
            avaliacaoQuantitativaInput.setAttribute('id', 'avaliacaoQuantitativa' + riscoCount);
            avaliacaoQuantitativaInput.setAttribute('name', 'avaliacaoQuantitativa');
            avaliacaoQuantitativaInput.setAttribute('accept', 'application/pdf');

            var fotosRiscoLabel = document.createElement('label');
            fotosRiscoLabel.setAttribute('for', 'fotosRisco' + riscoCount);
            fotosRiscoLabel.textContent = 'Fotos do Risco:';
            var fotosRiscoInput = document.createElement('input');
            fotosRiscoInput.setAttribute('type', 'file');
            fotosRiscoInput.setAttribute('id', 'fotosRisco' + riscoCount);
            fotosRiscoInput.setAttribute('name', 'fotosRisco');
            fotosRiscoInput.setAttribute('multiple', 'multiple');
            fotosRiscoInput.setAttribute('accept', 'image/*');

            riscoGroup.appendChild(riscoHeading);
            riscoGroup.appendChild(nomeRiscoLabel);
            riscoGroup.appendChild(nomeRiscoInput);
            riscoGroup.appendChild(fonteRiscoLabel);
            riscoGroup.appendChild(fonteRiscoInput);
            riscoGroup.appendChild(exposicaoRiscoLabel);
            riscoGroup.appendChild(exposicaoRiscoInput);
            riscoGroup.appendChild(propagacaoRiscoLabel);
            riscoGroup.appendChild(propagacaoRiscoInput);
            riscoGroup.appendChild(lesaoRiscoLabel);
            riscoGroup.appendChild(lesaoRiscoInput);
            riscoGroup.appendChild(tipoAvaliacaoRiscoLabel);
            riscoGroup.appendChild(tipoAvaliacaoRiscoSelect);
            riscoGroup.appendChild(avaliacaoQuantitativaContainer);
            avaliacaoQuantitativaContainer.appendChild(avaliacaoQuantitativaLabel);
            avaliacaoQuantitativaContainer.appendChild(avaliacaoQuantitativaInput);
            riscoGroup.appendChild(fotosRiscoLabel);
            riscoGroup.appendChild(fotosRiscoInput);

            riscosContainer.appendChild(riscoGroup);
        }

        function adicionarNovaFuncao() {
            var funcoesContainer = document.getElementById('funcoesContainer');
            var funcaoGroup = document.createElement('div');
            funcaoGroup.classList.add('funcao-group');

            var funcaoHeading = document.createElement('h3');
            funcaoHeading.textContent = 'Função ' + (funcoesContainer.children.length + 1);

            var funcaoLabel = document.createElement('label');
            funcaoLabel.setAttribute('for', 'funcao' + (funcoesContainer.children.length + 1));
            funcaoLabel.textContent = 'Função:';
            var funcaoInput = document.createElement('input');
            funcaoInput.setAttribute('type', 'text');
            funcaoInput.setAttribute('id', 'funcao' + (funcoesContainer.children.length + 1));
            funcaoInput.setAttribute('name', 'funcao');

            var riscosContainer = document.createElement('div');
            riscosContainer.setAttribute('id', 'riscosContainer' + (funcoesContainer.children.length + 1));

            var novoRiscoButton = document.createElement('button');
            novoRiscoButton.textContent = 'Adicionar Novo Risco';
            novoRiscoButton.addEventListener('click', function () {
                adicionarNovoRisco(funcoesContainer.children.length + 1);
            });

            funcaoGroup.appendChild(funcaoHeading);
            funcaoGroup.appendChild(funcaoLabel);
            funcaoGroup.appendChild(funcaoInput);
            funcaoGroup.appendChild(riscosContainer);
            funcaoGroup.appendChild(novoRiscoButton);

            funcoesContainer.appendChild(funcaoGroup);
        }
    </script>
</head>
<body>
    <h1>Checklist Provir Segurança Ocupacional</h1>
    
<?php
    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        // Dados do formulário
        $empresa = $_POST["empresa"];
        $ambiente = $_POST["ambiente"];
        
        // Processar funções e riscos
        $funcoes = array();
        if (isset($_POST["funcao"])) {
            $funcaoCount = count($_POST["funcao"]);
            
            for ($i = 0; $i < $funcaoCount; $i++) {
                $funcao = $_POST["funcao"][$i];
                $riscos = array();
                
                if (isset($_POST["nomeRisco"][$i])) {
                    $riscoCount = count($_POST["nomeRisco"][$i]);
                    
                    // Processar riscos
                    for ($j = 0; $j < $riscoCount; $j++) {
                        $nomeRisco = $_POST["nomeRisco"][$i][$j];
                        $fonteRisco = $_POST["fonteRisco"][$i][$j];
                        $exposicaoRisco = $_POST["exposicaoRisco"][$i][$j];
                        $propagacaoRisco = $_POST["propagacaoRisco"][$i][$j];
                        $lesoesRisco = $_POST["lesoesRisco"][$i][$j];
                        $tipoAvaliacaoRisco = $_POST["tipoAvaliacaoRisco"][$i][$j];
                        $avaliacaoQuantitativaRisco = $_FILES["avaliacaoQuantitativa"][$i][$j];
                        $fotosRisco = $_FILES["fotosRisco"][$i][$j];
                        
                        // Processar os dados do risco aqui...
                    }
                    
                    $funcoes[] = array(
                        "funcao" => $funcao,
                        "riscos" => $riscos
                    );
                }
            }
        }
        
        // Enviar e-mail com os dados ou fazer outras ações
if (isset($_POST['submit'])) {
    // Processar os dados do formulário aqui...

    // Construir o corpo do e-mail com os dados do formulário
    $emailBody = "Dados do formulário:\n\n";
    $emailBody .= "Nome: " . $_POST['nome'] . "\n";
    $emailBody .= "E-mail: " . $_POST['email'] . "\n";
    // Adicionar mais campos do formulário conforme necessário...

    // Criar um array com os caminhos dos arquivos anexos
    $arquivosAnexo = [];
    foreach ($_FILES['arquivo']['tmp_name'] as $tmpFile) {
        if (!empty($tmpFile)) {
            $arquivosAnexo[] = $tmpFile;
        }
    }

    // Gerar o nome do arquivo do Excel
    $excelFileName = 'formulario.xlsx';

    // Gerar o arquivo do Excel
    // (Substitua essa parte pelo código para gerar o arquivo Excel com os dados do formulário)
    // Exemplo simples:
    $excelData = [
        ['Nome', 'E-mail'],
        [$_POST['nome'], $_POST['email']],
        // Adicionar mais linhas com outros campos do formulário conforme necessário...
    ];
    $objPHPExcel = new PHPExcel();
    $objPHPExcel->getActiveSheet()->fromArray($excelData, NULL, 'A1');
    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
    $objWriter->save($excelFileName);

    // Enviar o e-mail com os dados do formulário e o arquivo Excel anexado
    $to = 'destinatario@example.com';
    $subject = 'Dados do formulário';
    $headers = 'From: remetente@example.com' . "\r\n" .
               'Reply-To: remetente@example.com' . "\r\n" .
               'Content-Type: text/plain; charset=utf-8' . "\r\n" .
               'X-Mailer: PHP/' . phpversion();
    
    $attachmentBoundary = "--" . md5(uniqid(mt_rand(), true));
    $emailBody .= "\n\n--" . $attachmentBoundary . "\n";
    $emailBody .= "Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet; name=" . $excelFileName . "\n";
    $emailBody .= "Content-Transfer-Encoding: base64\n";
    $emailBody .= "Content-Disposition: attachment; filename=" . $excelFileName . "\n\n";
    $emailBody .= chunk_split(base64_encode(file_get_contents($excelFileName)));
    $emailBody .= "\n\n--" . $attachmentBoundary . "--\n";

    // Envio do e-mail
    if (mail($to, $subject, $emailBody, $headers, "-fremetente@example.com")) {
        echo "E-mail enviado com sucesso.";
    } else {
        echo "Ocorreu um erro ao enviar o e-mail.";
    }

    // Remover o arquivo do Excel após o envio do e-mail
    unlink($excelFileName);

    // Redirecionar ou exibir uma mensagem de sucesso, conforme necessário
    // header('Location: success.html');
    // echo "Formulário enviado com sucesso!";
}

   
    ?>

    <form id="checklistForm" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="empresa">Nome da Empresa:</label>
            <input type="text" id="empresa" name="empresa">
        </div>
        <div class="form-group">
            <label for="ambiente">Nome do Ambiente:</label>
            <input type="text" id="ambiente" name="ambiente">
        </div>
        
        <div id="funcoesContainer">
            <?php
            if (!empty($funcoes)) {
                foreach ($funcoes as $index => $funcaoData) {
                    $funcao = $funcaoData["funcao"];
                    $riscos = $funcaoData["riscos"];
                    $funcaoIndex = $index + 1;
                    ?>
                    <div class="funcao">
                        <h2>Função <?php echo $funcaoIndex; ?></h2>
                        <input type="text" name="funcao[]" value="<?php echo $funcao; ?>" readonly>
                        
                        <!-- Campos para os riscos -->
                        <?php
                        if (!empty($riscos)) {
                            foreach ($riscos as $riscoIndex => $riscoData) {
                                $nomeRisco = $riscoData["nomeRisco"];
                                $fonteRisco = $riscoData["fonteRisco"];
                                $exposicaoRisco = $riscoData["exposicaoRisco"];
                                $propagacaoRisco = $riscoData["propagacaoRisco"];
                                $lesoesRisco = $riscoData["lesoesRisco"];
                                $tipoAvaliacaoRisco = $riscoData["tipoAvaliacaoRisco"];
                                $avaliacaoQuantitativaRisco = $riscoData["avaliacaoQuantitativaRisco"];
                                $fotosRisco = $riscoData["fotosRisco"];
                                ?>
                                <div class="risco">
                                    <h3>Risco <?php echo $riscoIndex + 1; ?></h3>
                                    <input type="text" name="nomeRisco[<?php echo $index; ?>][]" value="<?php echo $nomeRisco; ?>" readonly>
                                    <input type="text" name="fonteRisco[<?php echo $index; ?>][]" value="<?php echo $fonteRisco; ?>" readonly>
                                    <input type="text" name="exposicaoRisco[<?php echo $index; ?>][]" value="<?php echo $exposicaoRisco; ?>" readonly>
                                    <input type="text" name="propagacaoRisco[<?php echo $index; ?>][]" value="<?php echo $propagacaoRisco; ?>" readonly>
                                    <input type="text" name="lesoesRisco[<?php echo $index; ?>][]" value="<?php echo $lesoesRisco; ?>" readonly>
                                    <input type="text" name="tipoAvaliacaoRisco[<?php echo $index; ?>][]" value="<?php echo $tipoAvaliacaoRisco; ?>" readonly>
                                    <input type="file" name="avaliacaoQuantitativa[<?php echo $index; ?>][][]">
                                    <input type="file" name="fotosRisco[<?php echo $index; ?>][][]">
                                </div>
                                <?php
                            }
                        }
                        ?>
                    </div>
                    <?php
                }
            }
            ?>
        </div>
        
        <button type="submit">Enviar</button>
	<a href="mailto:administracao@clinicaprovir.com?subject=Dados%20do%20formulario&amp;body=Nome%3A%20<?php echo urlencode($_POST['nome']); ?>%0AEmail%3A%20<?php echo urlencode($_POST['email']); ?>">Enviar e-mail</a>

    </form>
</body>
</html>
